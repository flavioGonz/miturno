# Turnito Admin - Sistema de Gesti√≥n de Turnos y Control para Raspberry Pi

[![Node.js](https://img.shields.io/badge/Node.js-18+-green.svg)](https://nodejs.org/) [![Express.js](https://img.shields.io/badge/Express.js-4.x-blue.svg)](https://expressjs.com/) [![SQLite](https://img.shields.io/badge/Database-SQLite3-blue.svg)](https://www.sqlite.org/index.html) [![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

**Turnito Admin** es una soluci√≥n web todo-en-uno, dise√±ada para ejecutarse en un **Raspberry Pi** (idealmente con FullPageOS o una distribuci√≥n ligera de Debian/Ubuntu). Combina un robusto **sistema de gesti√≥n de turnos** con un potente **panel de control para la administraci√≥n remota del propio Raspberry Pi**.

Es la herramienta perfecta para peque√±os negocios, cl√≠nicas, oficinas o cualquier entorno que requiera organizar la atenci√≥n al p√∫blico y, al mismo tiempo, tener control total sobre el dispositivo que lo gestiona, todo desde una interfaz web amigable y completamente offline.

<img width="1898" height="934" alt="image" src="https://github.com/user-attachments/assets/33d7a5bd-57d5-4171-9f3e-ebce42b6f237" />


---

## ‚ú® Caracter√≠sticas Principales

El sistema se divide en dos grandes √°reas funcionales:

### üßæ Sistema de Gesti√≥n de Turnos

- **M√∫ltiples Colas de Servicio:** Administra diferentes departamentos o servicios (Ej: "Caja", "Atenci√≥n al Cliente") de forma simult√°nea.
- **Panel de Operador (`/sistema/control`):** Una interfaz intuitiva para que el personal pueda llamar, completar, saltar o agregar turnos con un solo clic.
- **Monitor P√∫blico (`/monitor`):** Una pantalla dise√±ada para televisores o monitores de cara al p√∫blico. Muestra el √∫ltimo turno llamado, el historial de llamadas y reproduce un sonido de notificaci√≥n.
- **Publicidad Din√°mica:** Sube im√°genes (JPG, PNG) desde el panel de administraci√≥n y mu√©stralas en un carrusel en el monitor p√∫blico, con intervalo de rotaci√≥n configurable.
- **Impresi√≥n de Tickets:** Soporte nativo para impresoras t√©rmicas (USB o Red) para emitir tickets f√≠sicos a los clientes.

### ‚öôÔ∏è Panel de Control del Raspberry Pi

- **Monitor de Sistema en Tiempo Real (`/sistema/resumen`):** Visualiza el uso de CPU, RAM, temperatura del procesador, espacio en disco y tiempo de actividad.
- **Control de GPIO (`/sistema/gpio`):** Interact√∫a con los pines GPIO del Raspberry Pi en tiempo real. Lee el estado de pulsadores y controla el encendido de LEDs o rel√©s directamente desde la web, con comunicaci√≥n bidireccional v√≠a WebSockets.
- **Administraci√≥n del Sistema Operativo:**
  - **Acciones de Energ√≠a:** Reinicia o apaga el Raspberry Pi de forma segura.
  - **Gesti√≥n de Servicios:** Habilita, deshabilita o reinicia servicios de `systemd`.
  - **Logs del Sistema:** Visualiza logs de `journalctl`, `dmesg` y del propio `pm2`.
  - **Actualizaciones del SO:** Lanza una actualizaci√≥n completa del sistema (`apt update && upgrade`).
- **Configuraci√≥n de Red (`/sistema/red`):** Visualiza el estado de la red y cambia entre modo Cliente WiFi y modo Hotspot Access Point.
- **Edici√≥n de Archivos de Configuraci√≥n:** Modifica archivos cr√≠ticos como `/boot/firmware/config.txt` y `/boot/firmware/fullpageos.txt` directamente desde la interfaz.

---

## üõ†Ô∏è Tecnolog√≠as Utilizadas

| Componente                                  | Tecnolog√≠a / M√≥dulo                                                       |
| :------------------------------------------ | :-------------------------------------------------------------------------- |
| **Backend**                           | Node.js, Express.js                                                         |
| **Base de Datos**                     | SQLite3 (con `connect-sqlite3` para sesiones)                             |
| **Frontend**                          | EJS (Server-Side Rendering), Tabler CSS (Dark Mode Offline)                 |
| **Comunicaci√≥n Real-Time**           | Socket.IO                                                                   |
| **Autenticaci√≥n**                    | `express-session`, `bcrypt`                                             |
| **Integraci√≥n Hardware (GPIO)**      | `pigpio-client` (sobre el daemon `pigpiod`)                             |
| **Integraci√≥n Hardware (Impresora)** | M√≥dulos nativos `usb` y `net` de Node.js                               |
| **Gesti√≥n de Procesos**              | PM2                                                                         |
| **Interacci√≥n con SO**               | `child_process` (ejecutando `systemctl`, `nmcli`, `vcgencmd`, etc.) |

---

## üöÄ Instalaci√≥n y Puesta en Marcha

Sigue estos pasos para tener Turnito funcionando en tu Raspberry Pi.

### 1. Prerrequisitos

Aseg√∫rate de tener lo siguiente instalado en tu sistema:

- **Node.js:** Versi√≥n 18 o superior.
- **NPM:** Gestor de paquetes de Node.js.
- **Git:** Para clonar el repositorio.
- **PM2:** Para gestionar el proceso en producci√≥n (`sudo npm install -g pm2`).
- **Daemon PIGPIO:** Esencial para el control de GPIO.
  ```bash
  sudo apt-get update
  sudo apt-get install pigpiod
  ```

### 2. Instalaci√≥n

```bash
# 1. Clona el repositorio en el directorio de tu preferencia (ej: /home/pi)
cd /home/pi
git clone [https://github.com/tu-usuario/turnito.git](https://github.com/flavioGonz/miturno) # <-- Reemplaza con tu URL de repo
cd turnito

# 2. Instala las dependencias del proyecto
npm install

# 3. Habilita y arranca el daemon pigpiod para que se inicie con el sistema
sudo systemctl enable pigpiod
sudo systemctl start pigpiod

# 4. Otorga permisos de GPIO al usuario actual (ej: pi) y reinicia
sudo usermod -aG gpio $(whoami)
sudo reboot
```

### 3. Ejecuci√≥n

#### Modo Desarrollo

Para pruebas y desarrollo, puedes iniciar la aplicaci√≥n directamente:

```bash
npm run dev
```

La aplicaci√≥n estar√° disponible en `http://<IP_RASPBERRY>:3000`.

#### Modo Producci√≥n (Recomendado)

Para un funcionamiento continuo y reinicio autom√°tico, usa PM2:

```bash
# Inicia la aplicaci√≥n con PM2 y dale un nombre
pm2 start index.js --name turnito

# Configura PM2 para que se inicie autom√°ticamente al arrancar el sistema
pm2 startup

# Guarda la configuraci√≥n actual de procesos de PM2
pm2 save
```

---

## üìñ Gu√≠a de Uso

### Acceso Inicial

1. Abre tu navegador y ve a `http://<IP_RASPBERRY>:3000`.
2. Ser√°s redirigido a la p√°gina de login.
3. Usa las credenciales por defecto:
   - **Usuario:** `admin`
   - **Contrase√±a:** `password`
4. **¬°Importante!** Se recomienda cambiar la contrase√±a por defecto lo antes posible.

### Paneles Principales

- **Panel de Control de Turnos:** `http://.../sistema/control`
- **Monitor P√∫blico:** `http://.../monitor`
- **Resumen del Sistema:** `http://.../sistema/resumen`
- **Control de GPIO:** `http://.../sistema/gpio`
- **Configuraci√≥n de Impresi√≥n:** `http://.../sistema/impresion`

---

## ü©∫ Diagn√≥stico y Pruebas con cURL

Para interactuar con la API directamente desde la l√≠nea de comandos, puedes usar `curl`. Como la mayor√≠a de los endpoints requieren autenticaci√≥n, primero necesitas iniciar sesi√≥n y guardar la cookie de sesi√≥n.

**Paso 1: Iniciar Sesi√≥n**

Ejecuta este comando para autenticarte con el usuario `admin` y la contrase√±a `password`. La cookie de sesi√≥n se guardar√° en `cookies.txt`. Reemplaza `<IP_RASPBERRY>` con la IP de tu dispositivo.

```bash
curl -X POST -c cookies.txt -d "username=admin&password=password" http://<IP_RASPBERRY>:3000/login
```

**Paso 2: Realizar Consultas a la API**

Ahora puedes usar el archivo `cookies.txt` para hacer llamadas a los endpoints protegidos.

**Ejemplos:**

* **Listar todas las colas de turnos:**

  ```bash
  curl -b cookies.txt http://<IP_RASPBERRY>:3000/api/queues
  ```
* **Crear una nueva cola llamada "Ventas":**

  ```bash
  curl -X POST -b cookies.txt -H "Content-Type: application/json" -d '{"name":"Ventas"}' http://<IP_RASPBERRY>:3000/api/queues
  ```
* **Llamar al siguiente turno de la cola con ID 1:**

  ```bash
  curl -X POST -b cookies.txt http://<IP_RASPBERRY>:3000/api/queues/1/call-next
  ```
* **Obtener el estado de los pines GPIO:**

  ```bash
  curl -b cookies.txt http://<IP_RASPBERRY>:3000/api/gpio/status
  ```
* **Obtener la temperatura del CPU:**

  ```bash
  curl -b cookies.txt http://<IP_RASPBERRY>:3000/api/system/cpu-temp
  ```
* **Enviar un ticket de prueba a la impresora:**

  ```bash
  curl -X POST -b cookies.txt http://<IP_RASPBERRY>:3000/api/print/test
  ```

---

## üîå Integraci√≥n de Hardware y Configuraciones por Defecto

### Control por GPIO

La aplicaci√≥n puede ser controlada por pulsadores f√≠sicos conectados a los pines GPIO.

- **Comunicaci√≥n:** `pigpio-client` se conecta al daemon `pigpiod` local y usa `socket.io` para notificar a la interfaz web en tiempo real.
- **Anti-rebote (Debounce):** Se implementa un sistema de anti-rebote por software para evitar lecturas m√∫ltiples en una sola pulsaci√≥n. El c√≥digo ignora cambios que ocurran en menos de 10ms.

**Mapa de pines por defecto (configurable en `index.js`):**

| Pin BCM | Direcci√≥n | Acci√≥n / Evento | Descripci√≥n                                         |
| :------ | :--------- | :--------------- | :--------------------------------------------------- |
| `17`  | IN         | `emit_ticket`  | Genera un nuevo turno en la cola 1.                  |
| `27`  | IN         | `next_turn`    | Llama al siguiente turno de la cola 1.               |
| `22`  | IN         | `prev_turn`    | Acci√≥n personalizada (actualmente solo log).        |
| `23`  | OUT        | `led`          | Indicador LED que puede ser controlado desde la web. |

<img width="1013" height="807" alt="image" src="https://github.com/user-attachments/assets/30672b95-6985-4dae-9e4b-11bdb6b2e54b" /> <img width="1016" height="808" alt="image" src="https://github.com/user-attachments/assets/02982077-bb79-48ca-8827-2a9a330d05a8" /><img width="1011" height="843" alt="image" src="https://github.com/user-attachments/assets/6c4ece14-8b19-4d11-8b0d-bde96e1cc639" />




### Impresora T√©rmica de Tickets

El sistema soporta impresoras de tickets de 80mm. Ve a la secci√≥n `/sistema/impresion` para configurar.

- **Modo USB (Por defecto):**
  - El sistema autodetecta impresoras con Vendor ID `0x0416` y Product ID `0x5011`.
- **Modo Red:**
  - Requiere configurar la IP de la impresora en el panel. La conexi√≥n se realiza por el puerto `9100`.

### Red y Otros

- **Hotspot Wi-Fi por defecto:** Si se activa el modo Hotspot, las credenciales por defecto son:
  - **SSID:** `TurnitoAP`
  - **Contrase√±a:** `turnito1234`
- **Cola Activa por Defecto:** La cola de turnos que se usa para las acciones de GPIO e impresi√≥n es, por defecto, la `queue_id = 1`.

---

<details>
<summary>üèõÔ∏è Arquitectura del C√≥digo y Estructura del Proyecto</summary>

### Arquitectura del C√≥digo

La aplicaci√≥n sigue una arquitectura monol√≠tica donde toda la l√≥gica del backend reside en un √∫nico archivo: `index.js`. Este archivo est√° organizado en secciones bien comentadas que manejan diferentes aspectos de la aplicaci√≥n en el siguiente orden:

1. **Configuraci√≥n Base:** Inicializaci√≥n de Express, Socket.IO y el servidor HTTP.
2. **Base de Datos:** Conexi√≥n a SQLite y creaci√≥n de las tablas si no existen.
3. **Configuraci√≥n de Express:** Middlewares, motor de plantillas (EJS) y sesiones.
4. **Autenticaci√≥n:** Rutas de Login/Logout y middleware de protecci√≥n de rutas.
5. **Rutas Principales:** Dashboard, vistas del sistema y monitor p√∫blico.
6. **L√≥gica de GPIO:** Conexi√≥n al daemon `pigpiod`, configuraci√≥n de pines, implementaci√≥n de anti-rebote (debounce) y manejo de eventos de hardware que disparan acciones en la aplicaci√≥n (ej. emitir ticket).
7. **API de Turnos (Queues):** Endpoints para crear, leer, actualizar y eliminar colas y turnos.
8. **API de Sistema:** Endpoints para interactuar con el sistema operativo (logs, servicios, red, archivos de configuraci√≥n, acciones de energ√≠a).
9. **API de Publicidad:** Endpoints para gestionar las im√°genes del carrusel del monitor.
10. **Manejo de Socket.IO:** Sincronizaci√≥n en tiempo real del estado de los GPIO entre el hardware y la interfaz web.
11. **Monitoreo de Sistema:** Endpoints que proveen datos de CPU, RAM, disco, etc.
12. **M√≥dulo de Impresi√≥n:** L√≥gica para detectar y enviar comandos a impresoras t√©rmicas USB o de red.
13. **Arranque del Servidor:** Inicia el servidor Express.

### Estructura del Proyecto

El directorio principal contiene varios archivos y carpetas. Los elementos clave para el funcionamiento de la aplicaci√≥n son:

```
turnito/
‚îú‚îÄ‚îÄ db/
‚îÇ   ‚îî‚îÄ‚îÄ turnito.db              # Base de datos SQLite (autogenerada)
‚îú‚îÄ‚îÄ public/                     # Archivos est√°ticos (CSS, JS, im√°genes, media)
‚îÇ   ‚îú‚îÄ‚îÄ css/
‚îÇ   ‚îú‚îÄ‚îÄ js/
‚îÇ   ‚îú‚îÄ‚îÄ img/
‚îÇ   ‚îî‚îÄ‚îÄ media/                  # Archivos para el carrusel de publicidad
‚îú‚îÄ‚îÄ views/                      # Plantillas EJS para la interfaz de usuario
‚îÇ   ‚îú‚îÄ‚îÄ layout.ejs              # Plantilla principal
‚îÇ   ‚îú‚îÄ‚îÄ login.ejs               # Vista de login
‚îÇ   ‚îú‚îÄ‚îÄ index.ejs               # Dashboard principal
‚îÇ   ‚îú‚îÄ‚îÄ monitor.ejs             # Pantalla p√∫blica de turnos
‚îÇ   ‚îî‚îÄ‚îÄ sistema/                # Vistas del panel de administraci√≥n
‚îú‚îÄ‚îÄ index.js                    # ¬°El coraz√≥n de la aplicaci√≥n! Servidor y toda la l√≥gica.
‚îú‚îÄ‚îÄ package.json                # Dependencias y scripts del proyecto
‚îî‚îÄ‚îÄ README.md                   # Este archivo
```

**Nota sobre otros directorios:** El proyecto contiene directorios como `miturno/`, `respaldo/` y numerosos archivos con el sufijo `copy`. Estos parecen ser copias de seguridad o versiones de desarrollo anteriores y **no son utilizados por la aplicaci√≥n principal**. El c√≥digo fuente activo se encuentra en la ra√≠z del directorio `turnito/`.

</details>

<details>
<summary>üóÑÔ∏è Esquema de la Base de Datos</summary>

La aplicaci√≥n utiliza una base de datos SQLite3. Al arrancar, se asegura de que las siguientes tablas existan, cre√°ndolas si es necesario.

**Tabla `users`**

```sql
CREATE TABLE IF NOT EXISTS users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  username TEXT UNIQUE,
  password TEXT
);
```

**Tabla `queues`**

```sql
CREATE TABLE IF NOT EXISTS queues (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT UNIQUE
);
```

**Tabla `turns`**

```sql
CREATE TABLE IF NOT EXISTS turns (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  queue_id INTEGER,
  turn_number INTEGER,
  status TEXT DEFAULT 'waiting', -- (waiting, calling, completed)
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

</details>

<details>
<summary>üì° Referencia de API Endpoints</summary>

La mayor√≠a de los endpoints requieren autenticaci√≥n de sesi√≥n.

#### Turnos y Colas (`/api/queues/...`)

- `GET /api/queues`: Lista todas las colas de servicio.
- `POST /api/queues`: Crea una nueva cola. Body: `{ "name": "NombreCola" }`.
- `PUT /api/queues/:id`: Actualiza el nombre de una cola. Body: `{ "name": "NuevoNombre" }`.
- `DELETE /api/queues/:id`: Elimina una cola y todos sus turnos asociados.
- `GET /api/queues/:id/turns`: Lista los turnos de una cola espec√≠fica.
- `POST /api/queues/:id/turns`: Crea un nuevo turno en una cola.
- `POST /api/queues/:id/call-next`: Marca el turno actual como completado y llama al siguiente en espera.

#### Sistema y Hardware (`/api/system/...`, `/api/gpio/...`)

- `GET /api/system/cpu-temp`: Temperatura del CPU.
- `GET /api/system/cpu-usage`: Uso de CPU en %.
- `GET /api/system/memory-usage`: Uso de RAM en %.
- `GET /api/system/disk-usage`: Uso del disco.
- `GET /api/system/uptime`: Tiempo de actividad del sistema.
- `GET /api/system/hostname`: Nombre del host del equipo.
- `POST /api/system/reboot`: Reinicia el sistema.
- `POST /api/system/shutdown`: Apaga el sistema.
- `POST /api/system/update-os`: Ejecuta `apt update && apt upgrade`.
- `GET /api/gpio/status`: Estado actual de los pines GPIO configurados.

#### Impresi√≥n (`/api/print/...`)

- `GET /api/print/status`: Verifica el estado de la impresora conectada (USB o Red).
- `POST /api/print/mode`: Cambia el modo de impresi√≥n. Body: `{ "mode": "usb" }` o `{ "mode": "network", "ip": "192.168.1.100" }`.
- `POST /api/print/test`: Imprime un ticket de prueba.

*(Existen m√°s endpoints para logs, servicios, red, etc., que pueden ser consultados en `index.js`)*

</details>

---

## üìÑ Licencia

Este proyecto est√° bajo la Licencia MIT.

## üë®‚Äçüíª Cr√©ditos

Desarrollado por **Flavio Gonz√°lez ‚Äì Infratec Networks**
Uruguay ‚Äì 2025
