<!--
  File: /home/fgonzalez/turnito/views/sistema/resumen.ejs
  Descripción: Monitoreo Premium con Glassmorphism y métricas avanzadas (v3.0)
-->

<div class="container-fluid py-4 min-vh-100"
  style="background: radial-gradient(circle at top right, rgba(32, 107, 196, 0.1), transparent 40%);">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="text-white mb-1"><i class="ti ti-activity text-primary me-2"></i>Monitoreo del Sistema</h2>
      <p class="text-secondary small mb-0">Estado real del hardware y servicios en la Raspberry Pi 3</p>
    </div>
    <div class="ms-auto text-end">
      <div id="connectionStatus" class="badge bg-green-lt animate-pulse">
        <i class="ti ti-plug me-1"></i> Conectado
      </div>
    </div>
  </div>

  <div class="row g-4 mb-4">
    <!-- CPU Chart Card -->
    <div class="col-xl-4 col-md-6">
      <div class="card glass-card border-0 h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <div class="text-secondary small fw-bold text-uppercase">CPU (%)</div>
              <h3 class="h1 mb-0" id="currentCPU">0%</h3>
            </div>
            <span class="avatar bg-primary-lt text-primary"><i class="ti ti-cpu"></i></span>
          </div>
          <div style="height: 120px;">
            <canvas id="cpuChart"></canvas>
          </div>
          <div class="mt-2 d-flex justify-content-around text-center small text-secondary">
            <div>
              <div class="fw-bold text-white" id="load1">0.00</div>1m
            </div>
            <div>
              <div class="fw-bold text-white" id="load5">0.00</div>5m
            </div>
            <div>
              <div class="fw-bold text-white" id="load15">0.00</div>15m
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- RAM Chart Card -->
    <div class="col-xl-4 col-md-6">
      <div class="card glass-card border-0 h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <div class="text-secondary small fw-bold text-uppercase">RAM (%)</div>
              <h3 class="h1 mb-0" id="currentRAM">0%</h3>
            </div>
            <span class="avatar bg-green-lt text-green"><i class="ti ti-device-memory"></i></span>
          </div>
          <div style="height: 120px;">
            <canvas id="ramChart"></canvas>
          </div>
          <div class="mt-2 text-center small text-secondary">
            SWAP: <span class="fw-bold text-white" id="swapUsage">--%</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Temp Chart Card -->
    <div class="col-xl-4 col-md-12">
      <div class="card glass-card border-0 h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <div class="text-secondary small fw-bold text-uppercase">Temperatura (°C)</div>
              <h3 class="h1 mb-0" id="currentTemp">0°C</h3>
            </div>
            <span class="avatar bg-orange-lt text-orange"><i class="ti ti-temperature"></i></span>
          </div>
          <div style="height: 120px;">
            <canvas id="tempChart"></canvas>
          </div>
          <div class="mt-2 text-center small text-secondary">
            Uptime: <span class="fw-bold text-white" id="uptime">--:--:--</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- Información de Servicio (PM2) -->
    <div class="col-md-5">
      <div class="card glass-card border-0 h-100">
        <div class="card-body">
          <h4 class="card-title text-info mb-4"><i class="ti ti-rocket-off me-2"></i>Estado del Servicio App</h4>
          <div id="pm2Detail">
            <div class="d-flex align-items-center mb-3">
              <span id="pm2StatusBadge" class="badge bg-secondary-lt me-2">VERIFICANDO</span>
              <span class="small text-secondary" id="pm2Uptime">--</span>
            </div>
            <div class="row g-2">
              <div class="col-6">
                <div class="p-2 border border-secondary border-dashed rounded text-center">
                  <div class="small text-secondary">Reinicios</div>
                  <div class="fw-bold h2 mb-0" id="pm2Restarts">0</div>
                </div>
              </div>
              <div class="col-6">
                <div class="p-2 border border-secondary border-dashed rounded text-center">
                  <div class="small text-secondary">Memoria App</div>
                  <div class="fw-bold h2 mb-0 text-azure" id="pm2Memory">--</div>
                </div>
              </div>
            </div>
          </div>

          <h4 class="card-title text-info mt-4 mb-3"><i class="ti ti-network me-2"></i>Interfaces de Red</h4>
          <div id="networkIps" class="small text-secondary">
            <div class="spinner-border spinner-border-sm" role="status"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- USB y Almacenamiento -->
    <div class="col-md-7">
      <div class="card glass-card border-0 h-100">
        <div class="card-body">
          <h4 class="card-title text-info mb-3"><i class="ti ti-device-usb me-2"></i>Dispositivos USB</h4>
          <div id="usbDevices" class="mb-4" style="max-height: 150px; overflow-y: auto;">
            <p class="text-secondary small italic">Detectando periféricos...</p>
          </div>

          <h4 class="card-title text-info mb-3"><i class="ti ti-database me-2"></i>Almacenamiento</h4>
          <div class="mb-2 d-flex justify-content-between small">
            <span class="text-secondary">Disco Principal</span>
            <span class="text-white" id="diskPct">--%</span>
          </div>
          <div class="progress progress-sm mb-3">
            <div id="diskBar" class="progress-bar bg-primary" style="width: 0%"></div>
          </div>
          <div class="text-secondary small d-flex align-items-center gap-3">
            <span><i class="ti ti-circle-filled text-blue me-1"></i> Usado</span>
            <span><i class="ti ti-circle-filled text-secondary me-1"></i> Libre</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="alertContainer" class="position-fixed bottom-0 end-0 p-3" style="z-index: 10000;"></div>
</div>

<style>
  .glass-card {
    background: rgba(255, 255, 255, 0.02);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.05);
  }

  .animate-pulse {
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0% {
      opacity: 1;
    }

    50% {
      opacity: 0.5;
    }

    100% {
      opacity: 1;
    }
  }

  .alert-box {
    background: rgba(50, 50, 50, 0.9);
    backdrop-filter: blur(10px);
    color: #fff;
    border-left: 4px solid #ff5252;
    padding: 12px 18px;
    margin-top: 10px;
    border-radius: 8px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
    animation: slideIn 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateX(50px);
    }

    to {
      opacity: 1;
      transform: translateX(0);
    }
  }
</style>

<script src="/js/chart.umd.js"></script>
<script>
  (async () => {
    const alertContainer = document.getElementById('alertContainer');

    const makeChart = (id, color) => new Chart(document.getElementById(id).getContext('2d'), {
      type: 'line',
      data: {
        labels: Array(25).fill(''),
        datasets: [{
          data: Array(25).fill(0),
          borderColor: color,
          borderWidth: 1.5,
          pointRadius: 0,
          fill: true,
          backgroundColor: color + '15',
          tension: 0.4
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false, animation: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { display: false },
          y: { min: 0, max: 100, ticks: { display: false }, grid: { display: false } }
        }
      }
    });

    const cpuChart = makeChart('cpuChart', '#206bc4');
    const ramChart = makeChart('ramChart', '#2fb344');
    const tempChart = makeChart('tempChart', '#f76707');

    async function getJSON(url) {
      try {
        const res = await fetch(url, { credentials: 'include' });
        return await res.json();
      } catch { return null; }
    }

    function addData(chart, val) {
      const d = chart.data.datasets[0].data;
      d.push(parseFloat(val || 0));
      if (d.length > 25) d.shift();
      chart.update();
    }

    function notify(msg, type = 'warning') {
      const div = document.createElement('div');
      div.className = `alert-box ${type}`;
      div.innerHTML = `<i class="ti ti-alert-triangle me-2"></i> ${msg}`;
      alertContainer.appendChild(div);
      setTimeout(() => div.remove(), 7000);
    }

    async function updateLoop() {
      const metrics = await Promise.all([
        getJSON('/api/system/cpu-usage'),
        getJSON('/api/system/memory-usage'),
        getJSON('/api/system/cpu-temp'),
        getJSON('/api/system/load-avg'),
        getJSON('/api/system/disk-usage'),
        getJSON('/api/system/uptime'),
        getJSON('/api/system/swap-usage'),
        getJSON('/api/system/pm2-status-detail'),
        getJSON('/api/system/network-ips')
      ]);

      const [cpu, mem, temp, load, disk, up, swap, pm2, nets] = metrics;

      if (cpu) {
        const v = parseFloat(cpu.cpu_usage || 0);
        document.getElementById('currentCPU').innerText = v + '%';
        addData(cpuChart, v);
        if (v > 90) notify(`Monitor: Carga de CPU Crítica (${v}%)`, 'danger text-danger');
      }

      if (mem) {
        const v = parseFloat(mem.ram || 0);
        document.getElementById('currentRAM').innerText = v + '%';
        addData(ramChart, v);
      }

      if (temp) {
        const v = parseFloat(temp.temperature || 0);
        document.getElementById('currentTemp').innerText = v + '°C';
        addData(tempChart, v);
        if (v > 75) notify(`Monitor: Temperatura de CPU alta (${v}°C)`, 'danger text-danger');
      }

      if (load) {
        document.getElementById('load1').innerText = load.load1;
        document.getElementById('load5').innerText = load.load5;
        document.getElementById('load15').innerText = load.load15;
      }

      if (disk) {
        document.getElementById('diskPct').innerText = disk.pct;
        document.getElementById('diskBar').style.width = disk.pct;
      }

      if (up) document.getElementById('uptime').innerText = up.uptime;
      if (swap) document.getElementById('swapUsage').innerText = swap.swap + '%';

      if (pm2) {
        const badge = document.getElementById('pm2StatusBadge');
        badge.innerText = (pm2.status || 'unknown').toUpperCase();
        badge.className = `badge ${pm2.status === 'online' ? 'bg-green-lt' : 'bg-red-lt'} me-2`;
        document.getElementById('pm2Uptime').innerText = 'UP: ' + pm2.uptime + 's';
        document.getElementById('pm2Restarts').innerText = pm2.restarts || 0;
        document.getElementById('pm2Memory').innerText = pm2.memory || '--';
      }

      if (nets) {
        const container = document.getElementById('networkIps');
        container.innerHTML = Object.keys(nets).map(iface => `
        <div class="mb-1">
          <span class="fw-bold text-white">${iface}:</span> 
          <span>${nets[iface].join(', ')}</span>
        </div>
      `).join('');
      }
    }

    async function updateHardware() {
      const usbs = await getJSON('/api/hardware/usb-devices');
      if (usbs) {
        const container = document.getElementById('usbDevices');
        container.innerHTML = usbs.map(dev => `
        <div class="p-2 mb-1 rounded bg-black-lt d-flex align-items-center gap-2" style="font-size: 0.75rem;">
          <i class="ti ti-circle-filled text-success" style="font-size: 0.5rem;"></i>
          ${dev}
        </div>
      `).join('');
      }
    }

    updateLoop();
    updateHardware();
    setInterval(updateLoop, 4000);
    setInterval(updateHardware, 15000); // Lsusb es más pesado, menos frecuente
  })();
</script>