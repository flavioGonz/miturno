<!--
  File: /home/fgonzalez/turnito/views/sistema/control.ejs
  DescripciÃ³n: Panel de Control de Turnos - RediseÃ±o visual moderno (v6.0)
  Autor: Flavio GonzÃ¡lez - Infratec Networks
-->

<div class="turnito-dashboard container-fluid py-4">
  <div class="header d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-cyan m-0 fw-bold"><i class="ti ti-users"></i> Panel de Control de Turnos</h2>

    <div id="activeQueueBanner" class="active-queue-banner d-none">
       <i class="ti ti-bolt text-cyan me-2"></i>
       <span>Cola activa: <strong id="activeQueueName">-</strong></span>
        <i class="ti ti-check text-success"></i>
     <span><strong>Cola activa:</strong> <span id="activeQueueName">-</span></span>
     </div>

    <button id="btnNewQueue" class="btn btn-glass">
      <i class="ti ti-plus"></i> Nueva Cola
    </button>
  </div>

  <div id="alertBox" class="alert d-none mt-3"></div>

<div class="row g-4">

  <!-- ðŸ“‹ Colas activas -->
  <div class="col-lg-4 col-md-6">
    <div class="card dashboard-card shadow-lg p-3 border-0 h-100">
      <div class="card-header border-0 bg-transparent px-2 pb-2">
        <h4 class="text-light m-0"><i class="ti ti-list"></i> Colas Activas</h4>
      </div>
      <div id="queueList" class="queue-list text-light mt-3">Cargando...</div>
    </div>
  </div>

  <!-- ðŸŽ› Panel de control -->
  <div class="col-lg-8 col-md-6">
    <div id="turnPanel" class="card dashboard-card border-0 shadow-lg p-4 d-none">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="text-light m-0">
          <i class="ti ti-bell"></i> Turnos - <span id="queueTitle"></span>
        </h4>
        <button id="btnBack" class="btn btn-outline-light btn-sm">
          <i class="ti ti-arrow-left"></i> Volver
        </button>
      </div>

      <div class="turn-info text-center my-4">
        <div class="text-muted small mb-2">Turno actual</div>
        <div id="currentTurnNumber" class="display-turn fw-bold text-cyan glow-text">--</div>
        <div id="currentTurnStatus" class="text-secondary fs-5 mt-2">Esperando llamada</div>
      </div>

      <div class="actions d-flex justify-content-center flex-wrap gap-3 mb-4">
        <button id="btnNext" class="btn-action green"><i class="ti ti-player-skip-forward me-2"></i>Llamar</button>
        <button id="btnComplete" class="btn-action blue"><i class="ti ti-check me-2"></i>Completar</button>
        <button id="btnSkip" class="btn-action yellow"><i class="ti ti-skip-forward me-2"></i>Saltar</button>
        <button id="btnAddTurn" class="btn-action outline"><i class="ti ti-plus me-2"></i>Agregar</button>
      </div>

      <h5 class="text-light mb-3"><i class="ti ti-history"></i> Ãšltimos Turnos</h5>
      <div id="turnList" class="turn-history"></div>
    </div>
  </div>
</div>


<script src="/socket.io/socket.io.js"></script>
<script>

// ðŸŸ¢ Mostrar cola activa guardada en backend (si existe)
async function checkActiveQueue() {
  try {
    const res = await fetch('/api/get-active-queue', { credentials: 'include' });
    const data = await res.json();
    if (data?.queue) {
      const banner = document.getElementById('activeQueueBanner');
      const nameEl = document.getElementById('activeQueueName');
      nameEl.textContent = data.queue.name;
      banner.classList.remove('d-none');
    }
  } catch (err) {
    console.warn('âš ï¸ No se pudo obtener la cola activa.');
  }
}
checkActiveQueue();


document.addEventListener('DOMContentLoaded', () => {

 async function checkActiveQueue() {
  try {
    const res = await fetch('/api/get-active-queue', { credentials: 'include' });
    const data = await res.json();
    if (data?.queue && data.queue.name) {
      document.getElementById('activeQueueName').textContent = data.queue.name;
      document.getElementById('activeQueueInfo').style.display = 'flex';
    }
  } catch {
    console.warn('âš ï¸ No se pudo obtener la cola activa al iniciar.');
  }
}
checkActiveQueue();

  
  const queueList = document.getElementById('queueList');
  const alertBox = document.getElementById('alertBox');
  const btnNewQueue = document.getElementById('btnNewQueue');
  const turnPanel = document.getElementById('turnPanel');
  const queueTitle = document.getElementById('queueTitle');
  const btnBack = document.getElementById('btnBack');
  const btnNext = document.getElementById('btnNext');
  const btnComplete = document.getElementById('btnComplete');
  const btnSkip = document.getElementById('btnSkip');
  const btnAddTurn = document.getElementById('btnAddTurn');
  const turnList = document.getElementById('turnList');
  const currentTurnNumber = document.getElementById('currentTurnNumber');
  const currentTurnStatus = document.getElementById('currentTurnStatus');
  let currentQueue = null;
  let currentTurn = null;

  const socket = io();

  socket.on('turn-update', data => {
    if (currentQueue && data.queue_id === currentQueue.id) loadTurns();
  });

  const showMsg = (msg, type = 'info') => {
    alertBox.className = `alert alert-${type}`;
    alertBox.textContent = msg;
    alertBox.classList.remove('d-none');
    clearTimeout(alertBox._hide);
    alertBox._hide = setTimeout(() => alertBox.classList.add('d-none'), 2500);
  };

  const getJSON = async (url, opts = {}) => {
    const res = await fetch(url, { credentials: 'include', ...opts });
    const txt = await res.text();
    try { return JSON.parse(txt); } catch { return {}; }
  };

  async function loadQueues() {
  const data = await getJSON('/api/queues');
  queueList.innerHTML = '';
  if (!data.length) {
    queueList.innerHTML = '<div class="text-muted text-center">No hay colas registradas.</div>';
    return;
  }

  data.forEach(q => {
    const el = document.createElement('div');
    el.className = 'queue-item card text-center bg-black border border-secondary p-3 mb-3';
    el.innerHTML = `
      <h5 class="m-0 text-light mb-3">${q.name}</h5>
      <div class="d-flex justify-content-center gap-2">
        <button class="btn btn-sm btn-outline-info openQueue" data-id="${q.id}" data-name="${q.name}">
          <i class="ti ti-terminal"></i>
        </button>
        <button class="btn btn-sm btn-outline-warning editQueue" data-id="${q.id}" data-name="${q.name}">
          <i class="ti ti-pencil"></i>
        </button>
        <button class="btn btn-sm btn-outline-danger deleteQueue" data-id="${q.id}" data-name="${q.name}">
          <i class="ti ti-trash"></i>
        </button>
      </div>
    `;

    // ðŸ“ž Abrir control
    el.querySelector('.openQueue').onclick = () => openQueue(q);

    // âœï¸ Editar
    el.querySelector('.editQueue').onclick = async () => {
      const newName = prompt(`Renombrar cola "${q.name}" a:`, q.name);
      if (!newName || newName === q.name) return;
      const res = await fetch(`/api/queues/${q.id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ name: newName })
      });
      if (res.ok) {
        showMsg('Cola renombrada', 'success');
        loadQueues();
      }
    };

    // ðŸ—‘ï¸ Eliminar
    el.querySelector('.deleteQueue').onclick = async () => {
      if (!confirm(`Â¿Eliminar la cola "${q.name}"?`)) return;
      const res = await fetch(`/api/queues/${q.id}`, {
        method: 'DELETE',
        credentials: 'include'
      });
      if (res.ok) {
        showMsg('Cola eliminada', 'danger');
        loadQueues();
      }
    };

    queueList.appendChild(el);
  });
}

// âœï¸ Editar nombre de cola
app.put('/api/queues/:id', isApiAuthenticated, (req, res) => {
  const { name } = req.body;
  db.run('UPDATE queues SET name = ? WHERE id = ?', [name, req.params.id], function (err) {
    if (err) return res.status(500).json({ error: err.message });
    res.json({ success: true });
  });
});

// ðŸ—‘ï¸ Eliminar cola
app.delete('/api/queues/:id', isApiAuthenticated, (req, res) => {
  db.run('DELETE FROM queues WHERE id = ?', [req.params.id], function (err) {
    if (err) return res.status(500).json({ error: err.message });
    db.run('DELETE FROM turns WHERE queue_id = ?', [req.params.id]);
    res.json({ success: true });
  });
});



  async function openQueue(queue) {
  currentQueue = queue;
  queueTitle.textContent = queue.name;

  // Oculta la lista y muestra el panel
  document.querySelector('.queue-list').classList.add('d-none');
  turnPanel.classList.remove('d-none');

  // ðŸ”„ Mostrar el banner de cola activa
  const banner = document.getElementById('activeQueueBanner');
  const nameEl = document.getElementById('activeQueueName');
  nameEl.textContent = queue.name;
  banner.classList.remove('d-none');

  // ðŸ”„ Notificar al backend cuÃ¡l es la cola activa
  try {
    await fetch(`/api/set-active-queue/${queue.id}`, { method: 'POST' });
    console.log(`ðŸŽ¯ Cola activa establecida en backend: ${queue.name} (ID ${queue.id})`);
  } catch (err) {
    console.error('âš ï¸ Error configurando cola activa:', err);
  }

  await loadTurns();
}



  btnBack.onclick = () => {
    turnPanel.classList.add('d-none');
    document.querySelector('.queue-list').classList.remove('d-none');
    currentQueue = null;
  };

  async function loadTurns() {
    const turns = await getJSON(`/api/queues/${currentQueue.id}/turns`);
    turnList.innerHTML = '';
    if (!turns.length) {
      currentTurnNumber.textContent = '--';
      currentTurnStatus.textContent = 'Sin turnos aÃºn';
      return;
    }

    currentTurn = turns.find(t => t.status === 'calling');
    if (currentTurn) {
      currentTurnNumber.textContent = currentTurn.turn_number;
      currentTurnStatus.textContent = 'En atenciÃ³n';
    } else {
      const last = turns[turns.length - 1];
      currentTurnNumber.textContent = last.turn_number;
      currentTurnStatus.textContent = 'Esperando llamada';
    }

    const recent = turns.slice(-6).reverse();
    recent.forEach(t => {
      const el = document.createElement('div');
      el.className = `turn-entry ${t.status}`;
      el.innerHTML = `<strong>#${t.turn_number}</strong> <span>${t.status}</span>`;
      turnList.appendChild(el);
    });
  }

  btnNewQueue.onclick = async () => {
    const name = prompt('Nombre de la nueva cola:');
    if (!name) return;
    const res = await fetch('/api/queues', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ name })
    });
    await res.json();
    showMsg('Cola creada correctamente', 'success');
    loadQueues();
  };

  btnAddTurn.onclick = async () => {
    const res = await fetch(`/api/queues/${currentQueue.id}/turns`, { method: 'POST', credentials: 'include' });
    const data = await res.json();
    showMsg(`Turno ${data.turn_number} agregado`, 'success');
    loadTurns();
  };

  btnNext.onclick = async () => {
    const res = await fetch(`/api/queues/${currentQueue.id}/call-next`, { method: 'POST', credentials: 'include' });
    const data = await res.json();
    showMsg(data.message || 'Siguiente turno llamado', 'info');
    loadTurns();
  };

  btnComplete.onclick = async () => {
    if (!currentTurn) return showMsg('No hay turno activo.', 'warning');
    await fetch(`/api/turns/${currentTurn.id}/complete`, { method: 'PUT', credentials: 'include' });
    showMsg('Turno completado.', 'success');
    loadTurns();
  };

  btnSkip.onclick = async () => {
    if (!currentTurn) return showMsg('No hay turno activo.', 'warning');
    await fetch(`/api/turns/${currentTurn.id}/skip`, { method: 'PUT', credentials: 'include' });
    showMsg('Turno saltado.', 'warning');
    loadTurns();
  };

  loadQueues();
});
</script>

<style>
:root {
  --cyan: #00bfff;
  --bg-dark: #0d1117;
  --bg-panel: #161b22;
}
.text-cyan { color: var(--cyan)!important; }
.bg-panel { background-color: var(--bg-panel)!important; }

.turnito-dashboard {
  background: var(--bg-dark);
  color: #fff;
  min-height: 100vh;
  overflow-x: hidden;
}

.btn-glass {
  background: rgba(0,191,255,0.1);
  border: 1px solid var(--cyan);
  color: var(--cyan);
  border-radius: 12px;
  padding: 8px 16px;
  transition: 0.2s;
}
.btn-glass:hover { background: var(--cyan); color: #000; }

.queue-item.hover:hover {
  background: rgba(0,191,255,0.15);
  transform: scale(1.03);
  transition: 0.2s ease;
}

.display-turn {
  font-size: 6rem;
  text-shadow: 0 0 25px var(--cyan);
}
.glow-text {
  animation: glowPulse 2s infinite alternate;
}
@keyframes glowPulse {
  from { text-shadow: 0 0 10px var(--cyan); }
  to { text-shadow: 0 0 30px var(--cyan); }
}

.btn-action {
  border: none;
  padding: 18px 36px;
  border-radius: 14px;
  font-size: 1.1rem;
  font-weight: 600;
  letter-spacing: 0.5px;
  color: #fff;
  transition: 0.2s;
  box-shadow: 0 0 15px rgba(0,0,0,0.3);
}
.btn-action.green { background: #00d97e; }
.btn-action.blue { background: #2196f3; }
.btn-action.yellow { background: #ffc107; color: #000; }
.btn-action.outline {
  border: 2px solid var(--cyan);
  background: transparent;
  color: var(--cyan);
}
.btn-action:hover { opacity: 0.85; transform: scale(1.03); }

.turn-history .turn-entry {
  padding: 10px 14px;
  border-radius: 8px;
  margin-bottom: 6px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #1e1e1e;
}
.turn-entry.calling { background: rgba(0,191,255,0.2); color: var(--cyan); }
.turn-entry.completed { background: rgba(0,255,100,0.15); color: #0f0; }
.turn-entry.skipped { background: rgba(255,255,0,0.2); color: #ff0; }
.turn-entry.waiting { background: rgba(255,255,255,0.08); color: #ccc; }

/* ðŸŸ¦ Banner cola activa */
.active-queue-banner {
  position: fixed;
  top: 75px;
  right: 25px;
  background: linear-gradient(90deg, #0b0f14, #0d1f2f);
  color: #00eaff;
  border: 1px solid #00eaff44;
  border-radius: 12px;
  padding: 10px 16px;
  font-size: 1rem;
  display: flex;
  align-items: center;
  gap: 6px;
  box-shadow: 0 0 12px #00eaff33;
  animation: slideIn 0.6s ease-out forwards;
  z-index: 2000;
}
@keyframes slideIn {
  from { transform: translateY(-20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}


/* ðŸ’  Dashboard-style cards */
.dashboard-card {
  background: linear-gradient(180deg, #111821, #0b0f14);
  border-radius: 16px;
  transition: all 0.25s ease;
  border: 1px solid #00eaff22;
}
.dashboard-card:hover {
  box-shadow: 0 0 20px rgba(0, 234, 255, 0.15);
  transform: translateY(-2px);
}

/* ðŸ§© Mejor distribuciÃ³n de grid */
@media (max-width: 992px) {
  .turnito-dashboard .row {
    flex-direction: column;
  }
}

/* âœ¨ Header alignment fix */
.header {
  flex-wrap: wrap;
  gap: 12px;
}


</style>
