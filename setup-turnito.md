
* Estado de `pigpiod`, `pm2`, `node`, `npm`, `sqlite3`
* Verificaci√≥n de red y servicios escuchando en el puerto 3000
* Informaci√≥n de hardware y carga del sistema
* Detecci√≥n de procesos hu√©rfanos o fallas comunes

---

## üß∞ Archivo completo

üìÑ `/home/fgonzalez/turnito/setup-turnito.sh`

<pre class="overflow-visible!" data-start="554" data-end="7577"><div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary"><div class="sticky top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-bash"><span><span>#!/bin/bash</span><span>
</span><span># ===============================================================</span><span>
</span><span>#  Turnito Admin - Instalador interactivo y reparaci√≥n de entorno</span><span>
</span><span>#  Autor: Infratec Networks - Flavio Gonz√°lez</span><span>
</span><span>#  Versi√≥n: 1.2 (Smart Setup + Diagn√≥stico)</span><span>
</span><span># ===============================================================</span><span>

APP_DIR=</span><span>"/home/fgonzalez/turnito"</span><span>
SERVICE_NAME=</span><span>"turnito"</span><span>

</span><span># --- Colores ---</span><span>
GREEN=</span><span>"\e[92m"</span><span>
YELLOW=</span><span>"\e[93m"</span><span>
RED=</span><span>"\e[91m"</span><span>
CYAN=</span><span>"\e[96m"</span><span>
RESET=</span><span>"\e[0m"</span><span>

</span><span>echo</span><span> -e </span><span>"${CYAN}</span><span>üöÄ Instalador interactivo de Turnito Admin</span><span>${RESET}</span><span>"
</span><span>echo</span><span></span><span>"Ubicaci√≥n actual: $APP_DIR</span><span>"
</span><span>echo</span><span></span><span>"---------------------------------------------"</span><span>

</span><span># --- Verificaci√≥n de versi√≥n de Node.js ---</span><span>
NODE_VER=$(node -v 2>/dev/null)
</span><span>if</span><span> [[ -z </span><span>"$NODE_VER</span><span>" ]]; </span><span>then</span><span>
  </span><span>echo</span><span> -e </span><span>"${RED}</span><span>‚ùå Node.js no est√° instalado.</span><span>${RESET}</span><span>"
  </span><span>echo</span><span></span><span>"Instalalo con:"</span><span>
  </span><span>echo</span><span> -e </span><span>"${CYAN}</span><span>curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -</span><span>${RESET}</span><span>"
  </span><span>echo</span><span> -e </span><span>"${CYAN}</span><span>sudo apt install -y nodejs</span><span>${RESET}</span><span>"
  </span><span>exit</span><span> 1
</span><span>else</span><span>
  </span><span>echo</span><span> -e </span><span>"${GREEN}</span><span>‚úî Node.js detectado: $NODE_VER</span><span>${RESET}</span><span>"
  NODE_MAJOR=$(node -v | grep -oP </span><span>'\d+'</span><span> | </span><span>head</span><span> -1)
  </span><span>if</span><span> (( NODE_MAJOR < </span><span>18</span><span> )); </span><span>then</span><span>
    </span><span>echo</span><span> -e </span><span>"${RED}</span><span>‚ö†Ô∏è Versi√≥n de Node.js obsoleta. Se recomienda >=18.</span><span>${RESET}</span><span>"
    </span><span>read</span><span> -p </span><span>"¬øContinuar de todos modos? (s/n): "</span><span> CONTINUE
    [[ </span><span>"$CONTINUE</span><span>" != </span><span>"s"</span><span> && </span><span>"$CONTINUE</span><span>" != </span><span>"S"</span><span> ]] && </span><span>exit</span><span> 1
  </span><span>fi</span><span>
</span><span>fi</span><span>

</span><span># --- Confirmar ubicaci√≥n ---</span><span>
</span><span>read</span><span> -p </span><span>"¬øQuer√©s continuar en esta ruta? (s/n): "</span><span> CONFIRM
</span><span>if</span><span> [[ </span><span>"$CONFIRM</span><span>" != </span><span>"s"</span><span> && </span><span>"$CONFIRM</span><span>" != </span><span>"S"</span><span> ]]; </span><span>then</span><span>
  </span><span>echo</span><span> -e </span><span>"${YELLOW}</span><span>Cancelado por el usuario.</span><span>${RESET}</span><span>"
  </span><span>exit</span><span> 0
</span><span>fi</span><span>

</span><span>cd</span><span></span><span>"$APP_DIR</span><span>" || { </span><span>echo</span><span> -e </span><span>"${RED}</span><span>‚ùå Carpeta no encontrada.</span><span>${RESET}</span><span>"; </span><span>exit</span><span> 1; }

</span><span># --- Men√∫ principal ---</span><span>
clear
</span><span>echo</span><span></span><span>"---------------------------------------------"</span><span>
</span><span>echo</span><span></span><span>"üì¶ Men√∫ principal:"</span><span>
</span><span>echo</span><span></span><span>"1) Instalaci√≥n completa (desde cero)"</span><span>
</span><span>echo</span><span></span><span>"2) Reinstalar dependencias"</span><span>
</span><span>echo</span><span></span><span>"3) Actualizar dependencias y reiniciar servicio"</span><span>
</span><span>echo</span><span></span><span>"4) Limpiar entorno (node_modules, lockfiles, cache)"</span><span>
</span><span>echo</span><span></span><span>"5) Salir"</span><span>
</span><span>echo</span><span></span><span>"6) üß™ Diagn√≥stico del sistema"</span><span>
</span><span>echo</span><span></span><span>"---------------------------------------------"</span><span>
</span><span>read</span><span> -p </span><span>"Seleccion√° una opci√≥n [1-6]: "</span><span> OPCION

</span><span># --- Funci√≥n de instalaci√≥n segura ---</span><span>
</span><span>install_deps</span><span>() {
  </span><span>echo</span><span> -e </span><span>"${CYAN}</span><span>üì• Instalando dependencias necesarias...</span><span>${RESET}</span><span>"
  npm install express express-session express-ejs-layouts express-fileupload \
    sqlite3 connect-sqlite3 bcrypt socket.io tabler-icons @tabler/core \
    pigpio-client pm2 child_process fs-extra node-fetch escpos escpos-network --save
}

</span><span># --- Diagn√≥stico del sistema ---</span><span>
</span><span>diagnostico</span><span>() {
  clear
  </span><span>echo</span><span> -e </span><span>"${CYAN}</span><span>üß™ Diagn√≥stico del entorno Turnito Admin</span><span>${RESET}</span><span>"
  </span><span>echo</span><span></span><span>"---------------------------------------------"</span><span>

  </span><span>echo</span><span> -e </span><span>"${YELLOW}</span><span>üîπ Versi√≥n de Node.js:</span><span>${RESET}</span><span></span><span>$(node -v 2>/dev/null || echo 'No encontrado')</span><span>"
  </span><span>echo</span><span> -e </span><span>"${YELLOW}</span><span>üîπ Versi√≥n de NPM:</span><span>${RESET}</span><span></span><span>$(npm -v 2>/dev/null || echo 'No encontrado')</span><span>"
  </span><span>echo</span><span> -e </span><span>"${YELLOW}</span><span>üîπ Versi√≥n de SQLite3:</span><span>${RESET}</span><span></span><span>$(sqlite3 --version 2>/dev/null || echo 'No encontrado')</span><span>"
  </span><span>echo</span><span></span><span>"---------------------------------------------"</span><span>

  </span><span>echo</span><span> -e </span><span>"${CYAN}</span><span>‚öôÔ∏è  Servicios:</span><span>${RESET}</span><span>"
  systemctl is-active --quiet pigpiod && </span><span>echo</span><span> -e </span><span>"${GREEN}</span><span>‚úî pigpiod activo</span><span>${RESET}</span><span>" || </span><span>echo</span><span> -e </span><span>"${RED}</span><span>‚ùå pigpiod inactivo</span><span>${RESET}</span><span>"
  pm2 describe </span><span>"$SERVICE_NAME</span><span>" >/dev/null 2>&1 && </span><span>echo</span><span> -e </span><span>"${GREEN}</span><span>‚úî PM2 ejecutando $SERVICE_NAME</span><span>${RESET}</span><span>" || </span><span>echo</span><span> -e </span><span>"${RED}</span><span>‚ùå PM2 no est√° corriendo $SERVICE_NAME</span><span>${RESET}</span><span>"

  </span><span>echo</span><span></span><span>"---------------------------------------------"</span><span>
  </span><span>echo</span><span> -e </span><span>"${CYAN}</span><span>üåê Conectividad de red:</span><span>${RESET}</span><span>"
  IP=$(hostname -I | awk </span><span>'{print $1}'</span><span>)
  </span><span>if</span><span> [[ -n </span><span>"$IP</span><span>" ]]; </span><span>then</span><span>
    </span><span>echo</span><span> -e </span><span>"${GREEN}</span><span>‚úî IP Local: $IP</span><span>${RESET}</span><span>"
    nc -z localhost 3000 >/dev/null 2>&1 && </span><span>echo</span><span> -e </span><span>"${GREEN}</span><span>‚úî Puerto 3000 activo</span><span>${RESET}</span><span>" || </span><span>echo</span><span> -e </span><span>"${RED}</span><span>‚ùå Puerto 3000 no responde</span><span>${RESET}</span><span>"
  </span><span>else</span><span>
    </span><span>echo</span><span> -e </span><span>"${RED}</span><span>‚ö†Ô∏è No se detect√≥ direcci√≥n IP.</span><span>${RESET}</span><span>"
  </span><span>fi</span><span>

  </span><span>echo</span><span></span><span>"---------------------------------------------"</span><span>
  </span><span>echo</span><span> -e </span><span>"${CYAN}</span><span>üíΩ Estado del sistema:</span><span>${RESET}</span><span>"
  </span><span>echo</span><span> -e </span><span>"Uptime: $(uptime -p)</span><span>"
  </span><span>echo</span><span> -e </span><span>"Carga: $(uptime | awk -F'load average:' '{print $2}')</span><span>"
  </span><span>echo</span><span> -e </span><span>"Uso de disco:"</span><span>
  </span><span>df</span><span> -h / | </span><span>tail</span><span> -1 | awk </span><span>'{print "‚Ä¢ " $1 ": " $3 "/" $2 " usados (" $5 ")"}'</span><span>

  </span><span>echo</span><span></span><span>"---------------------------------------------"</span><span>
  </span><span>echo</span><span> -e </span><span>"${CYAN}</span><span>üîç Procesos relacionados:</span><span>${RESET}</span><span>"
  ps aux | grep -E </span><span>"node|pigpiod|pm2"</span><span> | grep -v grep | awk </span><span>'{print "‚Ä¢ PID " $2 " - " $11}'</span><span>

  </span><span>echo</span><span></span><span>"---------------------------------------------"</span><span>
  </span><span>echo</span><span> -e </span><span>"${GREEN}</span><span>‚úÖ Diagn√≥stico finalizado.</span><span>${RESET}</span><span>"
  </span><span>echo</span><span>
  </span><span>read</span><span> -p </span><span>"Presion√° Enter para volver al men√∫..."</span><span>
  </span><span>exec</span><span></span><span>"$0</span><span>"
}

</span><span>case</span><span></span><span>$OPCION</span><span></span><span>in</span><span>
  1)
    </span><span>echo</span><span> -e </span><span>"${CYAN}</span><span>üßπ Limpieza de entorno anterior...</span><span>${RESET}</span><span>"
    </span><span>rm</span><span> -rf node_modules package-lock.json
    </span><span>sleep</span><span> 1
    </span><span>echo</span><span> -e </span><span>"${CYAN}</span><span>üì¶ Instalando Turnito Admin completo...</span><span>${RESET}</span><span>"
    install_deps
    ;;

  2)
    </span><span>echo</span><span> -e </span><span>"${CYAN}</span><span>‚ôªÔ∏è Reinstalando dependencias...</span><span>${RESET}</span><span>"
    </span><span>rm</span><span> -rf node_modules
    npm install
    ;;

  3)
    </span><span>echo</span><span> -e </span><span>"${CYAN}</span><span>üîÑ Actualizando dependencias...</span><span>${RESET}</span><span>"
    npm update
    ;;

  4)
    </span><span>echo</span><span> -e </span><span>"${YELLOW}</span><span>üßΩ Limpiando todo el entorno...</span><span>${RESET}</span><span>"
    </span><span>rm</span><span> -rf node_modules package-lock.json npm-shrinkwrap.json
    npm cache clean --force
    </span><span>echo</span><span> -e </span><span>"${GREEN}</span><span>‚úÖ Entorno limpio.</span><span>${RESET}</span><span>"
    ;;

  5)
    </span><span>echo</span><span> -e </span><span>"${YELLOW}</span><span>üëã Saliendo del instalador.</span><span>${RESET}</span><span>"
    </span><span>exit</span><span> 0
    ;;

  6)
    diagnostico
    </span><span>exit</span><span> 0
    ;;

  *)
    </span><span>echo</span><span> -e </span><span>"${RED}</span><span>‚ùå Opci√≥n inv√°lida.</span><span>${RESET}</span><span>"
    </span><span>exit</span><span> 1
    ;;
</span><span>esac</span><span>

</span><span># --- Confirmar configuraci√≥n de PM2 ---</span><span>
</span><span>echo</span><span>
</span><span>read</span><span> -p </span><span>"¬øQuer√©s configurar o reiniciar el servicio PM2 para Turnito? (s/n): "</span><span> PM2CONFIRM
</span><span>if</span><span> [[ </span><span>"$PM2CONFIRM</span><span>" == </span><span>"s"</span><span> || </span><span>"$PM2CONFIRM</span><span>" == </span><span>"S"</span><span> ]]; </span><span>then</span><span>
  </span><span>echo</span><span> -e </span><span>"${CYAN}</span><span>‚öôÔ∏è Configurando PM2...</span><span>${RESET}</span><span>"
  sudo systemctl </span><span>enable</span><span> pigpiod
  sudo systemctl start pigpiod
  pm2 stop </span><span>"$SERVICE_NAME</span><span>" >/dev/null 2>&1
  pm2 delete </span><span>"$SERVICE_NAME</span><span>" >/dev/null 2>&1
  pm2 start index.js --name </span><span>"$SERVICE_NAME</span><span>"
  pm2 save
  pm2 startup
  </span><span>echo</span><span> -e </span><span>"${GREEN}</span><span>‚úÖ Turnito Admin configurado en PM2.</span><span>${RESET}</span><span>"
</span><span>fi</span><span>

</span><span># --- Detecci√≥n de IP del Raspberry Pi ---</span><span>
IP=$(hostname -I | awk </span><span>'{print $1}'</span><span>)
</span><span>if</span><span> [[ -n </span><span>"$IP</span><span>" ]]; </span><span>then</span><span>
  </span><span>echo</span><span>
  </span><span>echo</span><span> -e </span><span>"${CYAN}</span><span>üåê Direcci√≥n IP detectada: </span><span>${GREEN}</span><span>$IP</span><span>${RESET}</span><span>"
  </span><span>echo</span><span> -e </span><span>"Pod√©s acceder desde: ${CYAN}</span><span>http://</span><span>$IP</span><span>:3000</span><span>${RESET}</span><span>"
</span><span>else</span><span>
  </span><span>echo</span><span> -e </span><span>"${RED}</span><span>‚ö†Ô∏è No se pudo detectar la IP autom√°ticamente.</span><span>${RESET}</span><span>"
</span><span>fi</span><span>

</span><span># --- FullPageOS Integration ---</span><span>
</span><span>if</span><span> [[ -f /boot/fullpageos.txt ]]; </span><span>then</span><span>
  </span><span>echo</span><span>
  </span><span>echo</span><span> -e </span><span>"${YELLOW}</span><span>üñ•Ô∏è Se detect√≥ FullPageOS.</span><span>${RESET}</span><span>"
  </span><span>read</span><span> -p </span><span>"¬øQuer√©s configurar la pantalla HDMI para mostrar /pantalla al inicio? (s/n): "</span><span> FPCONFIRM
  </span><span>if</span><span> [[ </span><span>"$FPCONFIRM</span><span>" == </span><span>"s"</span><span> || </span><span>"$FPCONFIRM</span><span>" == </span><span>"S"</span><span> ]]; </span><span>then</span><span>
    sudo sed -i </span><span>'/FULLPAGEOS_URL=/d'</span><span> /boot/fullpageos.txt
    </span><span>echo</span><span></span><span>"FULLPAGEOS_URL=http://localhost:3000/pantalla"</span><span> | sudo </span><span>tee</span><span> -a /boot/fullpageos.txt >/dev/null
    </span><span>echo</span><span> -e </span><span>"${GREEN}</span><span>‚úÖ FullPageOS configurado correctamente.</span><span>${RESET}</span><span>"
  </span><span>fi</span><span>
</span><span>fi</span><span>

</span><span># --- Finalizaci√≥n ---</span><span>
</span><span>echo</span><span>
</span><span>echo</span><span> -e </span><span>"${GREEN}</span><span>‚úÖ Instalaci√≥n finalizada.</span><span>${RESET}</span><span>"
</span><span>echo</span><span> -e </span><span>"Verific√° estado con: ${CYAN}</span><span>pm2 logs turnito</span><span>${RESET}</span><span>"
</span><span>echo</span><span> -e </span><span>"Servicio en ejecuci√≥n: ${CYAN}</span><span>http://</span><span>$IP</span><span>:3000</span><span>${RESET}</span><span>"
</span><span>echo</span><span> -e </span><span>"${YELLOW}</span><span>Reinici√° la Raspberry Pi si acab√°s de instalar pigpiod o PM2.</span><span>${RESET}</span><span>"
</span><span>echo</span><span></span><span>"---------------------------------------------"</span><span>
</span></span></code></div></div></pre>

---

## üß≠ Nuevas funciones

| Opci√≥n                                | Descripci√≥n                                               |
| -------------------------------------- | ---------------------------------------------------------- |
| **6 - Diagn√≥stico del sistema** | Revisa autom√°ticamente todos los servicios y dependencias |
| üîç**Node/NPM check**             | Muestra versiones y advierte si la versi√≥n es obsoleta    |
| ‚öôÔ∏è**pigpiod / PM2**            | Informa si est√°n activos                                  |
| üåê**Conectividad / puerto 3000** | Comprueba si Turnito responde en local                     |
| üíΩ**Uptime, carga y disco**      | Datos del estado del sistema                               |
| üß†**Procesos activos**           | Lista node, pigpiod y pm2                                  |
| üñ•Ô∏è**FullPageOS**               | Integraci√≥n opcional autom√°tica                          |

---

## üßæ Ejemplo de salida

<pre class="overflow-visible!" data-start="8178" data-end="8950"><div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary"><div class="sticky top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre!"><span><span>üß™ Diagn√≥stico del entorno Turnito Admin
---------------------------------------------
üîπ Versi√≥n de Node.js: v18.20.3
üîπ Versi√≥n de NPM: 10.6.0
üîπ Versi√≥n de SQLite3: 3.44.2
---------------------------------------------
‚öôÔ∏è  Servicios:
‚úî pigpiod activo
‚úî PM2 ejecutando turnito
---------------------------------------------
üåê Conectividad de red:
‚úî IP Local: 192.168.0.124
‚úî Puerto 3000 activo
---------------------------------------------
üíΩ Estado del sistema:
Uptime: up 2 hours, 31 minutes
Carga: 0.12, 0.08, 0.03
Uso de disco: ‚Ä¢ /dev/root: 3.2G/15G usados (21%)
---------------------------------------------
üîç Procesos relacionados:
‚Ä¢ PID 645 - node
‚Ä¢ PID 318 - pigpiod
‚Ä¢ PID 432 - pm2
---------------------------------------------
‚úÖ Diagn√≥stico finalizado.</span></span></code></div></div></pre>
