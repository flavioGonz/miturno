#!/bin/bash
# ===============================================================
#  Turnito Admin - Instalador interactivo y reparaci√≥n de entorno
#  Autor: Infratec Networks - Flavio Gonz√°lez
#  Versi√≥n: 1.2 (Smart Setup + Diagn√≥stico)
# ===============================================================

APP_DIR="/home/fgonzalez/turnito"
SERVICE_NAME="turnito"

# --- Colores ---
GREEN="\e[92m"
YELLOW="\e[93m"
RED="\e[91m"
CYAN="\e[96m"
RESET="\e[0m"

echo -e "${CYAN}üöÄ Instalador interactivo de Turnito Admin${RESET}"
echo "Ubicaci√≥n actual: $APP_DIR"
echo "---------------------------------------------"

# --- Verificaci√≥n de versi√≥n de Node.js ---
NODE_VER=$(node -v 2>/dev/null)
if [[ -z "$NODE_VER" ]]; then
  echo -e "${RED}‚ùå Node.js no est√° instalado.${RESET}"
  echo "Instalalo con:"
  echo -e "${CYAN}curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -${RESET}"
  echo -e "${CYAN}sudo apt install -y nodejs${RESET}"
  exit 1
else
  echo -e "${GREEN}‚úî Node.js detectado: $NODE_VER${RESET}"
  NODE_MAJOR=$(node -v | grep -oP '\d+' | head -1)
  if (( NODE_MAJOR < 18 )); then
    echo -e "${RED}‚ö†Ô∏è Versi√≥n de Node.js obsoleta. Se recomienda >=18.${RESET}"
    read -p "¬øContinuar de todos modos? (s/n): " CONTINUE
    [[ "$CONTINUE" != "s" && "$CONTINUE" != "S" ]] && exit 1
  fi
fi

# --- Confirmar ubicaci√≥n ---
read -p "¬øQuer√©s continuar en esta ruta? (s/n): " CONFIRM
if [[ "$CONFIRM" != "s" && "$CONFIRM" != "S" ]]; then
  echo -e "${YELLOW}Cancelado por el usuario.${RESET}"
  exit 0
fi

cd "$APP_DIR" || { echo -e "${RED}‚ùå Carpeta no encontrada.${RESET}"; exit 1; }

# --- Men√∫ principal ---
clear
echo "---------------------------------------------"
echo "üì¶ Men√∫ principal:"
echo "1) Instalaci√≥n completa (desde cero)"
echo "2) Reinstalar dependencias"
echo "3) Actualizar dependencias y reiniciar servicio"
echo "4) Limpiar entorno (node_modules, lockfiles, cache)"
echo "5) Salir"
echo "6) üß™ Diagn√≥stico del sistema"
echo "---------------------------------------------"
read -p "Seleccion√° una opci√≥n [1-6]: " OPCION

# --- Funci√≥n de instalaci√≥n segura ---
install_deps() {
  echo -e "${CYAN}üì• Instalando dependencias necesarias...${RESET}"
  npm install express express-session express-ejs-layouts express-fileupload \
    sqlite3 connect-sqlite3 bcrypt socket.io tabler-icons @tabler/core \
    pigpio-client pm2 child_process fs-extra node-fetch escpos escpos-network --save
}

# --- Diagn√≥stico del sistema ---
diagnostico() {
  clear
  echo -e "${CYAN}üß™ Diagn√≥stico del entorno Turnito Admin${RESET}"
  echo "---------------------------------------------"

  echo -e "${YELLOW}üîπ Versi√≥n de Node.js:${RESET} $(node -v 2>/dev/null || echo 'No encontrado')"
  echo -e "${YELLOW}üîπ Versi√≥n de NPM:${RESET} $(npm -v 2>/dev/null || echo 'No encontrado')"
  echo -e "${YELLOW}üîπ Versi√≥n de SQLite3:${RESET} $(sqlite3 --version 2>/dev/null || echo 'No encontrado')"
  echo "---------------------------------------------"

  echo -e "${CYAN}‚öôÔ∏è  Servicios:${RESET}"
  systemctl is-active --quiet pigpiod && echo -e "${GREEN}‚úî pigpiod activo${RESET}" || echo -e "${RED}‚ùå pigpiod inactivo${RESET}"
  pm2 describe "$SERVICE_NAME" >/dev/null 2>&1 && echo -e "${GREEN}‚úî PM2 ejecutando $SERVICE_NAME${RESET}" || echo -e "${RED}‚ùå PM2 no est√° corriendo $SERVICE_NAME${RESET}"

  echo "---------------------------------------------"
  echo -e "${CYAN}üåê Conectividad de red:${RESET}"
  IP=$(hostname -I | awk '{print $1}')
  if [[ -n "$IP" ]]; then
    echo -e "${GREEN}‚úî IP Local: $IP${RESET}"
    nc -z localhost 3000 >/dev/null 2>&1 && echo -e "${GREEN}‚úî Puerto 3000 activo${RESET}" || echo -e "${RED}‚ùå Puerto 3000 no responde${RESET}"
  else
    echo -e "${RED}‚ö†Ô∏è No se detect√≥ direcci√≥n IP.${RESET}"
  fi

  echo "---------------------------------------------"
  echo -e "${CYAN}üíΩ Estado del sistema:${RESET}"
  echo -e "Uptime: $(uptime -p)"
  echo -e "Carga: $(uptime | awk -F'load average:' '{print $2}')"
  echo -e "Uso de disco:"
  df -h / | tail -1 | awk '{print "‚Ä¢ " $1 ": " $3 "/" $2 " usados (" $5 ")"}'

  echo "---------------------------------------------"
  echo -e "${CYAN}üîç Procesos relacionados:${RESET}"
  ps aux | grep -E "node|pigpiod|pm2" | grep -v grep | awk '{print "‚Ä¢ PID " $2 " - " $11}'

  echo "---------------------------------------------"
  echo -e "${GREEN}‚úÖ Diagn√≥stico finalizado.${RESET}"
  echo
  read -p "Presion√° Enter para volver al men√∫..."
  exec "$0"
}

case $OPCION in
  1)
    echo -e "${CYAN}üßπ Limpieza de entorno anterior...${RESET}"
    rm -rf node_modules package-lock.json
    sleep 1
    echo -e "${CYAN}üì¶ Instalando Turnito Admin completo...${RESET}"
    install_deps
    ;;

  2)
    echo -e "${CYAN}‚ôªÔ∏è Reinstalando dependencias...${RESET}"
    rm -rf node_modules
    npm install
    ;;

  3)
    echo -e "${CYAN}üîÑ Actualizando dependencias...${RESET}"
    npm update
    ;;

  4)
    echo -e "${YELLOW}üßΩ Limpiando todo el entorno...${RESET}"
    rm -rf node_modules package-lock.json npm-shrinkwrap.json
    npm cache clean --force
    echo -e "${GREEN}‚úÖ Entorno limpio.${RESET}"
    ;;

  5)
    echo -e "${YELLOW}üëã Saliendo del instalador.${RESET}"
    exit 0
    ;;

  6)
    diagnostico
    exit 0
    ;;

  *)
    echo -e "${RED}‚ùå Opci√≥n inv√°lida.${RESET}"
    exit 1
    ;;
esac

# --- Confirmar configuraci√≥n de PM2 ---
echo
read -p "¬øQuer√©s configurar o reiniciar el servicio PM2 para Turnito? (s/n): " PM2CONFIRM
if [[ "$PM2CONFIRM" == "s" || "$PM2CONFIRM" == "S" ]]; then
  echo -e "${CYAN}‚öôÔ∏è Configurando PM2...${RESET}"
  sudo systemctl enable pigpiod
  sudo systemctl start pigpiod
  pm2 stop "$SERVICE_NAME" >/dev/null 2>&1
  pm2 delete "$SERVICE_NAME" >/dev/null 2>&1
  pm2 start index.js --name "$SERVICE_NAME"
  pm2 save
  pm2 startup
  echo -e "${GREEN}‚úÖ Turnito Admin configurado en PM2.${RESET}"
fi

# --- Detecci√≥n de IP del Raspberry Pi ---
IP=$(hostname -I | awk '{print $1}')
if [[ -n "$IP" ]]; then
  echo
  echo -e "${CYAN}üåê Direcci√≥n IP detectada: ${GREEN}$IP${RESET}"
  echo -e "Pod√©s acceder desde: ${CYAN}http://$IP:3000${RESET}"
else
  echo -e "${RED}‚ö†Ô∏è No se pudo detectar la IP autom√°ticamente.${RESET}"
fi

# --- FullPageOS Integration ---
if [[ -f /boot/fullpageos.txt ]]; then
  echo
  echo -e "${YELLOW}üñ•Ô∏è Se detect√≥ FullPageOS.${RESET}"
  read -p "¬øQuer√©s configurar la pantalla HDMI para mostrar /pantalla al inicio? (s/n): " FPCONFIRM
  if [[ "$FPCONFIRM" == "s" || "$FPCONFIRM" == "S" ]]; then
    sudo sed -i '/FULLPAGEOS_URL=/d' /boot/fullpageos.txt
    echo "FULLPAGEOS_URL=http://localhost:3000/pantalla" | sudo tee -a /boot/fullpageos.txt >/dev/null
    echo -e "${GREEN}‚úÖ FullPageOS configurado correctamente.${RESET}"
  fi
fi

# --- Finalizaci√≥n ---
echo
echo -e "${GREEN}‚úÖ Instalaci√≥n finalizada.${RESET}"
echo -e "Verific√° estado con: ${CYAN}pm2 logs turnito${RESET}"
echo -e "Servicio en ejecuci√≥n: ${CYAN}http://$IP:3000${RESET}"
echo -e "${YELLOW}Reinici√° la Raspberry Pi si acab√°s de instalar pigpiod o PM2.${RESET}"
echo "---------------------------------------------"
